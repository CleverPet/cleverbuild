#!/usr/bin/env python

import os
import re
import subprocess
import tempfile


def run(cmd):
    print("----------------------------------------------------------------------")
    print("%s" % cmd)
    print("----------------------------------------------------------------------")
    if os.system(cmd) != 0:
        raise Exception(cmd)


# https://blog.codinghorror.com/sorting-for-humans-natural-sort-order
def sort_human(l):
    convert = lambda text: int(text) if text.isdigit() else text
    alphanum_key = lambda key: [convert(c) for c in re.split('([0-9]+)', key)]
    l.sort(key=alphanum_key)


run("git fetch --tags")
git_branch = subprocess.Popen("git rev-parse --abbrev-ref HEAD".split(), stdout=subprocess.PIPE).communicate()[0].splitlines()[0]

# get latest tag
all_tags = []
branch_tags = []
for line in subprocess.Popen("git tag".split(), stdout=subprocess.PIPE).communicate()[0].splitlines():
    tag = os.path.basename(line)
    if "cleverbuild" in tag:
        all_tags.append(tag)
    if "cleverbuild-%s-" % git_branch in tag:
        branch_tags.append(tag)
sort_human(all_tags)
sort_human(branch_tags)

# compute diff
if len(branch_tags) > 0:
    run("! git --no-pager diff --exit-code %s..origin/%s" % (branch_tags[-1], git_branch))

# compute new tag
build_number = 0
if len(all_tags) > 0:
    build_number = int(re.findall("[0-9]+", all_tags[-1])[-1])
next_build_number = build_number + 1

newtag = "cleverbuild-%s-%s" % (git_branch, next_build_number)

# set CLEVERBUILD_TAG env var
os.environ["CLEVERBUILD_TAG"] = newtag

# set CLEVERBUILD_NUMBER env var
os.environ["CLEVERBUILD_NUMBER"] = str(next_build_number)

# set GIT_COMMIT env var
git_commit_cmd = "git rev-parse origin/%s" % git_branch
git_commit = subprocess.Popen(git_commit_cmd.split(), stdout=subprocess.PIPE).communicate()[0].splitlines()[0]
os.environ["GIT_COMMIT"] = git_commit

# work_tree
os.system("mkdir -p %s/cleverbuild" % tempfile.gettempdir())
work_tree = tempfile.mkdtemp(dir="%s/cleverbuild" % tempfile.gettempdir())
run("git archive origin/%s | tar -x -C %s" % (git_branch, work_tree))

# run cleverbuild
dot_cleverbuild = ".cleverbuild"
run("cd %s && if [ -f %s ]; then ./%s; fi" % (work_tree, dot_cleverbuild, dot_cleverbuild))

# git tag
run("git tag %s origin/%s" % (newtag, git_branch))
run("git push origin %s" % newtag)

# git log
# if len(tags) > 0:
#     run("git --no-pager log --decorate %s..%s" % (tags[-1], newtag))
